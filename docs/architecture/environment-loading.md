# 环境变量加载设计说明（Environment Loading Design）

本文档说明 **Jinsie AI Agent Platform** 中环境变量加载的工程化设计，
重点解释为何同时提供 **direnv** 与 **脚本兜底方案（load_env.sh）**，
以及该设计在团队协作、工程规范和可维护性上的价值。

---

## 设计背景

AI 应用工程通常依赖以下敏感或环境相关配置：

- 模型 API Key
- 模型名称 / 版本
- OpenAI-compatible Base URL
- Embedding / RAG 相关配置

这些配置具有以下特点：

- ❌ 不应提交到 Git 仓库
- ❌ 不应硬编码在代码中
- ✅ 必须在运行时可靠可用
- ✅ 在不同开发者 / 环境中可灵活切换

因此，本项目采用 **“双层环境变量加载策略”**。

---

## 总体设计原则

1. **安全优先**
   - `.env` 文件永不提交
   - 敏感信息仅存在于本地环境

2. **工程一致性**
   - 所有运行入口（CLI / API / Tests）使用同一套环境变量

3. **低摩擦协作**
   - 高级用户可享受自动化
   - 普通用户不需要额外工具也能运行

4. **显式失败**
   - 环境变量缺失时立即失败
   - 不进入“半可用”状态

---

## 方案一：direnv（推荐方案）

### 设计动机

`direnv` 是一个基于目录的环境变量自动加载工具：

- 进入目录 → 自动加载 `.envrc`
- 离开目录 → 自动卸载环境变量
- 与 shell 会话强绑定，不污染全局环境

这非常适合 **多项目并行开发** 的工程场景。

### 项目中的实现方式

项目根目录提供：

```text
.envrc
```

其职责包括：

1. 激活 Python / Conda 环境
2. 从 `.env` 文件加载环境变量
3. 保证变量只在当前项目生效

示意流程：

```text
cd project/
  → direnv 触发
    → 加载 .envrc
      → 激活 conda
      → export OPENAI_* 变量
```

### 使用方式

```bash
cp .env.example .env
direnv allow
```

之后每次进入项目目录，环境变量都会自动可用。

### 优点总结

- 零心智负担（无需每次手动 source）
- 环境隔离强
- 非侵入式，不影响系统全局配置

---

## 方案二：脚本兜底（load_env.sh）

### 为什么需要兜底方案？

并非所有开发者都会安装 `direnv`：

- 新同事 / 实习生
- CI / 自动化脚本
- 最小化环境（云主机、容器）

如果项目 **只依赖 direnv**，会导致：

- 初次运行失败
- 排错成本高
- 对工具链有隐式依赖

因此，本项目提供 **显式脚本兜底方案**。

---

## load_env.sh 的设计说明

路径：

```text
scripts/load_env.sh
```

### 设计原则

- 显式执行（必须 `source`）
- 仅加载 `.env` 中定义的变量
- 不修改系统级配置
- 行为可预测、可审计

### 使用方式

```bash
source scripts/load_env.sh
```

⚠️ 注意：

- **必须使用 `source`**
- 直接执行脚本无法将变量注入当前 shell

---

## 为什么不用 python-dotenv 自动加载？

虽然 `python-dotenv` 在应用启动时加载 `.env` 很方便，但在本项目中被刻意避免：

- ❌ 隐式加载，排错困难
- ❌ CLI / API 行为不一致
- ❌ 环境状态不透明

本项目选择：

> **在“代码运行之前”完成环境变量加载**

从而保证：

- CLI / API / 测试行为一致
- 失败尽早暴露
- 工程状态清晰可控

---

## 运行时校验（Fail Fast）

所有关键入口在初始化阶段都会校验：

- `OPENAI_API_KEY`
- `OPENAI_MODEL`

若缺失，将直接抛出异常并终止执行。

这种设计符合：

- 工程可预测性
- CI / 自动化运行安全性

---

## 推荐实践（团队协作）

- 本地开发：优先使用 `direnv`
- 临时环境 / CI：使用 `source scripts/load_env.sh`
- 永远不要提交 `.env`
- 永远维护 `.env.example`

---

## 工程加分点

该环境变量设计体现了：

- 对安全性的明确认知
- 对多开发者协作的考虑
- 对工具链差异的包容
- 对工程“可失败性”的重视

这是典型的 **生产级 AI 应用工程设计**，
而非 Demo 或课程项目。

---

## 推荐提交信息

```text
docs(architecture): document environment loading strategy with direnv fallback
```
